import secrets
import string
from typing import List

SIMILARES = set("il1Lo0O")
AMBIGUOS = set("{}[]()/\\'`~,;:.<>")

def build_charset(use_lower=True, use_upper=True, use_digits=True, use_symbols=True,
                  exclude_similar=True, avoid_ambiguous=True) -> str:
    charset = ""
    if use_lower:
        charset += string.ascii_lowercase
    if use_upper:
        charset += string.ascii_uppercase
    if use_digits:
        charset += string.digits
    if use_symbols:
        charset += "!@#$%^&*-=+?_"
    if exclude_similar:
        charset = ''.join(ch for ch in charset if ch not in SIMILARES)
    if avoid_ambiguous:
        charset = ''.join(ch for ch in charset if ch not in AMBIGUOS)
    return charset

def ensure_minimums(password_chars: List[str], pools: List[str]):
    idxs = list(range(len(password_chars)))
    secrets.SystemRandom().shuffle(idxs)
    for pool, i in zip([p for p in pools if p], idxs):
        password_chars[i] = secrets.choice(pool)

def has_sequences(pw: str, max_run: int = 3) -> bool:
    if len(pw) < max_run:
        return False
    def runs(s: str):
        run = 1
        for i in range(1, len(s)):
            if ord(s[i]) - ord(s[i-1]) == 1:
                run += 1
                if run >= max_run:
                    return True
            else:
                run = 1
        return False
    lower = ''.join(c for c in pw if c.isalpha()).lower()
    digits = ''.join(c for c in pw if c.isdigit())
    return runs(lower) or runs(digits)

def generate_password(length=12,
                      use_lower=True, use_upper=True,
                      use_digits=True, use_symbols=True,
                      exclude_similar=True, avoid_ambiguous=True,
                      no_repeats=False, no_sequences_flag=True,
                      max_attempts=1000) -> str:
    if length < 4:
        raise ValueError("La longitud mÃ­nima recomendada es 4.")
    pools = []
    if use_lower:
        pools.append(''.join(ch for ch in string.ascii_lowercase if (ch not in SIMILARES if exclude_similar else True)))
    if use_upper:
        pools.append(''.join(ch for ch in string.ascii_uppercase if (ch not in SIMILARES if exclude_similar else True)))
    if use_digits:
        pools.append(''.join(ch for ch in string.digits if (ch not in SIMILARES if exclude_similar else True)))
    if use_symbols:
        base_symbols = "!@#$%^&*-=+?_"
        pools.append(''.join(ch for ch in base_symbols if (ch not in AMBIGUOS if avoid_ambiguous else True)))
    charset = build_charset(use_lower, use_upper, use_digits, use_symbols, exclude_similar, avoid_ambiguous)
    if not charset:
        raise ValueError("No hay caracteres disponibles: activa al menos una categorÃ­a.")
    rng = secrets.SystemRandom()
    for _ in range(max_attempts):
        password_chars = [''] * length
        ensure_minimums(password_chars, pools)
        for i in range(length):
            if password_chars[i] == '':
                c = rng.choice(charset)
                if no_repeats:
                    while i > 0 and c == password_chars[i-1]:
                        c = rng.choice(charset)
                password_chars[i] = c
        pw = ''.join(password_chars)
        if no_sequences_flag and has_sequences(pw):
            continue
        return pw
    raise RuntimeError("No se pudo generar una contraseÃ±a que cumpla restricciones.")

def score_password(pw: str) -> int:
    unique = len(set(pw))
    length = len(pw)
    variety = sum([any(c.islower() for c in pw),
                   any(c.isupper() for c in pw),
                   any(c.isdigit() for c in pw),
                   any(c in "!@#$%^&*-=+?_" for c in pw)])
    score = unique * 2 + length + variety * 4
    return min(100, score)

def describe_strength(score: int) -> str:
    if score >= 80:
        return "Muy fuerte"
    if score >= 60:
        return "Fuerte"
    if score >= 40:
        return "Media"
    return "DÃ©bil"

# ======================
# ðŸš€ Uso directo en Python
# ======================
if __name__ == "__main__":
    length = 16       # longitud de la contraseÃ±a
    count = 5         # cuÃ¡ntas generar
    use_lower = True
    use_upper = True
    use_digits = True
    use_symbols = True
    exclude_similar = True
    avoid_ambiguous = True
    no_repeats = True
    no_sequences_flag = True

    for i in range(count):
        pw = generate_password(length=length,
                               use_lower=use_lower, use_upper=use_upper,
                               use_digits=use_digits, use_symbols=use_symbols,
                               exclude_similar=exclude_similar, avoid_ambiguous=avoid_ambiguous,
                               no_repeats=no_repeats, no_sequences_flag=no_sequences_flag)
        score = score_password(pw)
        print(f"{i+1:02d}) {pw}  |  fuerzaâ‰ˆ{score}/100 ({describe_strength(score)})")
01) Jp#x3%yE^C7f2u$  |  fuerzaâ‰ˆ95/100 (Muy fuerte)
02) H7$tLr!G2zWm*q6X |  fuerzaâ‰ˆ92/100 (Muy fuerte)
...

   
